**ARCHITECTURE ASSISTANT PERSONNEL - SYNTHÃˆSE**

# VISION GLOBALE

**Concept central** : Un Coordinateur orchestre tous les Ã©changes entre User, App et IA via une interface de commandes JSON universelle.

**Principe clÃ©** : Un seul processus nÃ©cessitant cohÃ©rence ou modification des donnÃ©es actif Ã  la fois.

---

# MODÃˆLE DE DONNÃ‰ES

## HiÃ©rarchie
```
Zones (conteneurs thÃ©matiques)
  â””â”€â”€ Instances d'outils (configurations)
        â””â”€â”€ DonnÃ©es (enregistrements)
```

## Tables essentielles
- `zones` â†’ Conteneurs thÃ©matiques
- `tool_instances` â†’ Configurations avec `config_json` + `config_metadata_json`
- `[type]_data` â†’ Une table de donnÃ©es par type d'outil (ex: `tracking_data`)

## Philosophie
- **ImmutabilitÃ©** : Les enregistrements copient les valeurs (pas de rÃ©fÃ©rences, sauf leur tool instance id)
- **Miroir metadata** : Chaque JSON a sa description parallÃ¨le
- **Config centralisÃ©e** : Pour les instances : tout dans `config_json`, pas de tables auxiliaires

---

# MIROIR METADATA

- Structure avec `_meta` systÃ©matique (rÃ©cusrsive):

```json
"field_name": {
  "_meta": {
    "type": "string",
    "required": true,
    "description": "..."
  }
  "sub_field":{
    "_meta": {
      "type": "string",
      "required": true,
      "description": "..."
    }
  }
}
```

# LE COORDINATEUR = Machine Ã  Ã©tats centralisÃ©e

## Ã‰tats possibles
- `idle` - Attente
- `dialogue_ia` - Discussion en cours
- `operation_en_cours` - Traitement actif
- `validation_requise` - Attente confirmation
- etc. (extensible)

## Gestion des prioritÃ©s
1. Actions User (max)
2. RÃ©ponses IA (haute)
3. TÃ¢ches auto (basse)

## Gestion des interruptions
- **Phase critique** : Attente obligatoire
- **Phase interruptible** : Confirmation ("Interrompre? Devra recommencer")

## Ce qui passe par le coordinateur
- Modification de donnÃ©es
- Actions qui utilisent la db pour leur cohÃ©rence
- Session dialogue IA
- ...

## Ce qui ne passe pas par le coordinateur
- Navigation pure : consultation donnÃ©es, changement d'Ã©cran
- Processus passifs : monitoring capteurs, etc.


# SYSTÃˆME D'OPÃ‰RATIONS

- Toute action utilisant ou modifiant des donnÃ©es est une "opÃ©ration".

## Sources d'opÃ©rations

- Tools (instances) : identifiÃ©s par instance_id
- Services Core (singletons) : `backup_service`, `sync_service`, `maintenance_service`, `migration_service`, etc.


## Cycle de vie des opÃ©rations

1. Commande JSON arrive

{
  "action": "execute->tools->tracking->rebuild_totals",
  "params": {
    "instance_id": "uuid-1234",
    "year": 2024,
    "force": true
  }
}

2. Coordinateur parse et enregistre
val opId = coordinator.registerOperation(
    source_type = "tool",
    source_id = params["instance_id"],
    operation = "rebuild_totals",
    params = params,  // Le JSON complet
    initiated_by = "user"
)

3. Coordinateur route vers le tool
val tool = toolManager.getTool("tracking")
val token = coordinator.getToken(opId)
tool.execute(
    operation = "rebuild_totals",
    params = params,  // Passe le JSON
    token = token
)

4. Tool exÃ©cute avec les params
fun execute(operation: String, params: JsonObject, token: CancellationToken) {
    when(operation) {
        "rebuild_totals" -> {
            val year = params["year"].asInt
            rebuildTotals(year, token)
        }
    }
}

## Points clÃ©s
- Coordinateur gÃ©nÃ¨re l'ID et garde les tokens
- Tool/Service vÃ©rifie rÃ©guliÃ¨rement `token.isCancelled`
- Un seul pattern pour tous les tools et services


# INTERFACE DE COMMANDE

## Sources d'actions (initiated_by)
- `user` - via interaction UI
- `ai` - via commande
- `scheduler` - TÃ¢che programmÃ©e
- `trigger` - Ã‰vÃ©nement auto
- `cascade` - ConsÃ©quence d'une autre commande

## Exemple d'Ã©change IA <-> App
**Commande** :
```json
[{
  "action": "modify->tools->tracking->add_item",
  "params": {...}
}]
```

**RÃ©ponse** :
```json
[{
  "command_index": 0,
  "status": "success|error|...",
  "requested_data": {...},
  "message": "..."
}]
```


# SYSTÃˆME DE VALIDATION

## Flux complet
1. **DÃ©clencheur** : Action initiÃ©e (user/ai/scheduler...)
2. **Analyse** : Coordinateur dÃ©termine si besoin de validation
3. **DÃ©lÃ©gation** : Si oui : Coordinateur â†’ UI "Affiche fenÃªtre validation"
4. **Attente** : Ã‰tat `validation_requise`
5. **RÃ©ponse** : UI â†’ Coordinateur confirmation
6. **ExÃ©cution** : Action effectuÃ©e ou annulÃ©e

## RÃ¨gles configurables
- `always` - Toujours valider
- `never` - Jamais
- etc. (extensible, ex envisagÃ©s : `if_has_data` `if_multiple` `in_dialogue`)

## RÃ¨gles de validation par source
```json
"delete_group": {
  "_meta": {
    "requires_validation": {
      "ai": "always",
      "user": "always",
      "scheduler": "never"
    }
  }
}
```


# ARCHITECTURE SYSTÃˆMES

```
                    COORDINATEUR
            (orchestre opÃ©rations & Ã©tats)
                         |
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        |                |                |
   [User â†” App]    [App Core]       [App â†” IA]
    - UI            - Services       - Prompts
    - Validation    - Tools          - Commandes
                    - DonnÃ©es        - File attente

              [SystÃ¨mes transversaux]
         - Verbalisation - RÃ©seau - ThÃ¨mes

              [Processus parallÃ¨les]
         - Monitoring - Terminal - ...
```


# ğŸ“ EXEMPLES DE FLUX

## OpÃ©ration tool avec interruption
1. User lance recalcul dans Suivi
2. Tool enregistre opÃ©ration au Coordinateur
3. Tool signale `phase: "interruptible"`
4. User veut ajouter donnÃ©e
5. Coordinateur â†’ UI "Interrompre recalcul?"
6. Si oui â†’ token.cancel() â†’ tool s'arrÃªte
7. Action user s'exÃ©cute

## OpÃ©ration service core
1. Scheduler dÃ©clenche backup quotidien
2. `backup_service` enregistre opÃ©ration
3. Service lit toutes les instances
4. Phase `critical` pendant Ã©criture fichier
5. User tente action â†’ "Patientez 3 sec"
6. Backup termine â†’ Ã©tat `idle`

## Validation selon source
1. IA envoie `delete_group`
2. Coordinateur vÃ©rifie metadata.json
3. Voit `"ai": "always"`
4. Demande validation Ã  User
5. User refuse
6. Coordinateur retourne `status: "cancelled"` Ã  IA


