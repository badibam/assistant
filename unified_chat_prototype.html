<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat IA Unifié avec Enrichissements</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
        }

        /* Chat container */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .chat-container.active {
            transform: translateY(0);
        }

        /* Header */
        .chat-header {
            padding: 10px 15px;
            background: #333;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 50px;
        }

        .session-title {
            font-weight: 600;
            color: #fff;
            font-size: 14px;
        }

        .session-controls {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }

        .btn-actions { background: #ff9500; color: white; }
        .btn-status { background: #0066cc; color: white; }
        .btn-close { background: #ff3b30; color: white; }

        /* Messages area */
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.4;
            font-size: 14px;
        }

        .message.user {
            background: #0066cc;
            color: white;
            align-self: flex-end;
        }

        .message.ai {
            background: #3a3a3a;
            color: #e0e0e0;
            align-self: flex-start;
        }

        /* Enrichissements dans messages */
        .enrichment-block {
            background: rgba(255, 149, 0, 0.1);
            border-left: 3px solid #ff9500;
            padding: 8px 12px;
            margin: 6px 0;
            border-radius: 4px;
            font-size: 12px;
            color: #ff9500;
        }

        .enrichment-block.readonly {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Zone de saisie unifiée */
        .input-section {
            background: #333;
            border-top: 1px solid #444;
            padding: 15px;
        }

        .input-textarea {
            width: 100%;
            min-height: 80px;
            max-height: 200px;
            background: #2a2a2a;
            border: 1px solid #555;
            border-radius: 8px;
            color: #e0e0e0;
            padding: 12px;
            font-size: 14px;
            line-height: 1.4;
            resize: vertical;
            outline: none;
            font-family: inherit;
        }

        .input-textarea:focus {
            border-color: #0066cc;
        }

        /* Barre de boutons */
        .button-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            gap: 10px;
            flex-wrap: nowrap;
        }

        .enrichment-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            flex-shrink: 1;
        }

        .enrich-btn {
            padding: 8px 12px;
            background: #444;
            border: none;
            border-radius: 6px;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .enrich-btn:hover {
            background: #555;
            transform: translateY(-1px);
        }

        .send-btn {
            padding: 10px 20px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.2s;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .send-btn:hover {
            background: #0052a3;
        }

        .send-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        /* Enrichissements éditables dans textarea */
        .enrichment-inline {
            background: rgba(255, 149, 0, 0.2);
            border: 1px solid #ff9500;
            border-radius: 4px;
            padding: 4px 8px;
            margin: 2px;
            display: inline-block;
            cursor: pointer;
            font-size: 12px;
            color: #ff9500;
            user-select: none;
        }

        .enrichment-inline:hover {
            background: rgba(255, 149, 0, 0.3);
        }

        /* Overlays de configuration */
        .config-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .config-overlay.active {
            display: flex;
        }

        .config-content {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .config-title {
            font-weight: 600;
            color: #fff;
            font-size: 16px;
        }

        .config-close {
            background: none;
            border: none;
            color: #aaa;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }

        .config-section {
            margin-bottom: 15px;
        }

        .config-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #fff;
            font-size: 13px;
        }

        .config-input, .config-select, .config-textarea {
            width: 100%;
            padding: 8px 12px;
            background: #1a1a1a;
            border: 1px solid #555;
            border-radius: 4px;
            color: #e0e0e0;
            outline: none;
        }

        .config-textarea {
            height: 80px;
            resize: vertical;
        }

        .config-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .config-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .config-btn.save {
            background: #0066cc;
            color: white;
        }

        .config-btn.cancel {
            background: #666;
            color: white;
        }

        /* Overlays État et Historique */
        .status-overlay, .history-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1500;
            padding: 20px;
        }

        .status-overlay.active, .history-overlay.active {
            display: flex;
        }

        .overlay-content {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .overlay-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .overlay-title {
            font-weight: 600;
            color: #fff;
            font-size: 16px;
        }

        .overlay-close {
            background: none;
            border: none;
            color: #aaa;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }

        .overlay-section {
            margin-bottom: 20px;
        }

        .overlay-section-title {
            font-weight: 600;
            color: #fff;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .overlay-section-content {
            color: #e0e0e0;
            font-size: 13px;
            line-height: 1.4;
        }

        /* Bouton toggle */
        .toggle-chat {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #0066cc;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* Clavier mobile simulé */
        .mobile-keyboard {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 280px;
            background: #2a2a2a;
            border-top: 1px solid #555;
            z-index: 1001;
            padding: 10px;
            display: none;
        }

        .mobile-keyboard.active {
            display: block;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            margin: 4px 0;
            gap: 2px;
        }

        .key {
            background: #444;
            border: 1px solid #666;
            border-radius: 4px;
            color: #e0e0e0;
            padding: 12px;
            min-width: 28px;
            text-align: center;
            font-size: 16px;
            user-select: none;
        }

        .key.space { flex: 3; }
        .key.wide { flex: 1.5; }

        /* Ajustements avec clavier ouvert */
        body.keyboard-open .chat-container {
            height: calc(100vh - 280px);
        }

        /* Responsive */
        .chat-container.active {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 999;
        }
        
        @media (max-width: 768px) {
            .enrichment-buttons {
                gap: 6px;
            }
            
            .enrich-btn {
                font-size: 11px;
                padding: 6px 8px;
            }
            
            .session-controls {
                gap: 6px;
            }
            
            .btn {
                font-size: 11px;
                padding: 5px 8px;
            }
            
            .enrichment-buttons {
                gap: 4px;
            }
            
            .enrich-btn {
                padding: 6px 8px;
                font-size: 14px;
            }
            
            .send-btn {
                padding: 8px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Bouton pour activer le chat -->
    <button class="toggle-chat" onclick="toggleChat()">🤖</button>

    <!-- Interface Chat Unifiée -->
    <div class="chat-container" id="chatContainer">
        <!-- Header -->
        <div class="chat-header">
            <div class="session-title">💬 Chat IA Unifié</div>
            <div class="session-controls">
                <button class="btn btn-actions" onclick="showHistory()">📜</button>
                <button class="btn btn-status" onclick="showStatus()">📊</button>
                <button class="btn btn-close" onclick="toggleChat()">✕</button>
            </div>
        </div>

        <!-- Messages -->
        <div class="messages" id="messages">
            <div class="message ai">Bonjour ! Comment puis-je vous aider aujourd'hui ?</div>
            
            <div class="message user">
                Peux-tu analyser mes données de sommeil ?
                <div class="enrichment-block readonly">
                    📊 Données: Zone Santé • 30 jours • Détail élevé
                </div>
                <div class="enrichment-block readonly">
                    📝 Doc: "J'ai changé mes habitudes le 15 du mois"
                </div>
            </div>
            
            <div class="message ai">Parfait ! J'analyse vos données de sommeil des 30 derniers jours. Je vois que vous avez changé vos habitudes le 15. Voulez-vous que je compare avant/après cette date ?</div>
        </div>

        <!-- Zone de saisie unifiée -->
        <div class="input-section">
            <textarea 
                class="input-textarea" 
                id="messageTextarea" 
                placeholder="Tapez votre message...

Utilisez les boutons ci-dessous pour enrichir votre message avec des données, actions, etc."
                onclick="showKeyboard()"
                onfocus="showKeyboard()"
            ></textarea>
            
            <div class="button-bar">
                <div class="enrichment-buttons">
                    <button class="enrich-btn" onclick="addEnrichment('data')">🔍</button>
                    <button class="enrich-btn" onclick="addEnrichment('use')">📝</button>
                    <button class="enrich-btn" onclick="addEnrichment('create')">✨</button>
                    <button class="enrich-btn" onclick="addEnrichment('modify')">🔧</button>
                    <button class="enrich-btn" onclick="addEnrichment('organize')">📁</button>
                    <button class="enrich-btn" onclick="addEnrichment('document')">📚</button>
                </div>
                
                <button class="send-btn" onclick="sendMessage()">Envoyer</button>
            </div>
        </div>
    </div>

    <!-- Overlay de configuration des enrichissements -->
    <div class="config-overlay" id="configOverlay">
        <div class="config-content">
            <div class="config-header">
                <div class="config-title" id="configTitle">Configuration</div>
                <button class="config-close" onclick="closeConfig()">✕</button>
            </div>
            
            <div id="configContent">
                <!-- Contenu dynamique selon le type d'enrichissement -->
            </div>
            
            <div class="config-actions">
                <button class="config-btn cancel" onclick="closeConfig()">Annuler</button>
                <button class="config-btn save" onclick="saveConfig()">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- Overlay État -->
    <div class="status-overlay" id="statusOverlay">
        <div class="overlay-content">
            <div class="overlay-header">
                <div class="overlay-title">📊 État de la session</div>
                <button class="overlay-close" onclick="hideStatus()">✕</button>
            </div>
            
            <div class="overlay-section">
                <div class="overlay-section-title">Statut</div>
                <div class="overlay-section-content">
                    🟢 Session Active<br>
                    Démarrée il y a 3 min 42s
                </div>
            </div>
            
            <div class="overlay-section">
                <div class="overlay-section-title">Consommation</div>
                <div class="overlay-section-content">
                    <strong>Tokens :</strong> 1,247 / 4,000<br>
                    <strong>Coût :</strong> 0,12€<br>
                    <strong>Requêtes :</strong> 3
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay Historique -->
    <div class="history-overlay" id="historyOverlay">
        <div class="overlay-content">
            <div class="overlay-header">
                <div class="overlay-title">📜 Historique d'activité</div>
                <button class="overlay-close" onclick="hideHistory()">✕</button>
            </div>
            
            <div class="overlay-section">
                <div style="color: #aaa; font-size: 11px; margin-bottom: 15px; text-align: center;">
                    Chronologie des actions IA ↔ Utilisateur
                </div>
                
                <div style="font-size: 12px; line-height: 1.6; color: #e0e0e0;">
                    <div style="margin-bottom: 8px; padding: 6px 0; border-bottom: 1px solid #333;">
                        <span style="color: #666; font-size: 10px;">[15:42]</span> 
                        <span style="color: #0066cc;">IA</span>: Analyse des données de sommeil demandée
                    </div>
                    <div style="margin-bottom: 8px; padding: 6px 0; border-bottom: 1px solid #333;">
                        <span style="color: #666; font-size: 10px;">[15:43]</span> 
                        <span style="color: #0066cc;">IA</span>: Accès aux données → Zone Santé • Suivi Sommeil • 30j
                    </div>
                    <div style="margin-bottom: 8px; padding: 6px 0; border-bottom: 1px solid #333;">
                        <span style="color: #666; font-size: 10px;">[15:44]</span> 
                        <span style="color: #ff9500;">USER</span>: Validation création graphique corrélation
                    </div>
                    <div style="margin-bottom: 8px; padding: 6px 0;">
                        <span style="color: #666; font-size: 10px;">[15:45]</span> 
                        <span style="color: #0066cc;">IA</span>: Graphique créé → "Corrélation Sommeil-Sport"
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Clavier mobile simulé -->
    <div class="mobile-keyboard" id="mobileKeyboard">
        <div class="keyboard-row">
            <div class="key">q</div>
            <div class="key">w</div>
            <div class="key">e</div>
            <div class="key">r</div>
            <div class="key">t</div>
            <div class="key">y</div>
            <div class="key">u</div>
            <div class="key">i</div>
            <div class="key">o</div>
            <div class="key">p</div>
        </div>
        <div class="keyboard-row">
            <div class="key">a</div>
            <div class="key">s</div>
            <div class="key">d</div>
            <div class="key">f</div>
            <div class="key">g</div>
            <div class="key">h</div>
            <div class="key">j</div>
            <div class="key">k</div>
            <div class="key">l</div>
        </div>
        <div class="keyboard-row">
            <div class="key">z</div>
            <div class="key">x</div>
            <div class="key">c</div>
            <div class="key">v</div>
            <div class="key">b</div>
            <div class="key">n</div>
            <div class="key">m</div>
            <div class="key">⌫</div>
        </div>
        <div class="keyboard-row">
            <div class="key">?</div>
            <div class="key space">espace</div>
            <div class="key">.</div>
            <div class="key wide">✓</div>
        </div>
    </div>

    <script>
        let chatActive = false;
        let currentEnrichmentType = null;
        let editingEnrichmentIndex = null;
        let enrichments = []; // Stockage des enrichissements

        // Gestion du chat
        function toggleChat() {
            const container = document.getElementById('chatContainer');
            chatActive = !chatActive;
            
            if (chatActive) {
                container.classList.add('active');
                document.querySelector('.toggle-chat').innerHTML = '✕';
            } else {
                container.classList.remove('active');
                document.querySelector('.toggle-chat').innerHTML = '🤖';
                hideKeyboard(); // Fermer le clavier si ouvert
            }
        }

        // Gestion du clavier
        function showKeyboard() {
            const keyboard = document.getElementById('mobileKeyboard');
            document.body.classList.add('keyboard-open');
            keyboard.classList.add('active');
        }

        function hideKeyboard() {
            const keyboard = document.getElementById('mobileKeyboard');
            document.body.classList.remove('keyboard-open');
            keyboard.classList.remove('active');
        }

        // Gestion des overlays
        function showStatus() {
            document.getElementById('statusOverlay').classList.add('active');
        }

        function hideStatus() {
            document.getElementById('statusOverlay').classList.remove('active');
        }

        function showHistory() {
            document.getElementById('historyOverlay').classList.add('active');
        }

        function hideHistory() {
            document.getElementById('historyOverlay').classList.remove('active');
        }

        // Configuration des enrichissements
        const enrichmentConfigs = {
            data: {
                title: "🔍 Configuration Données",
                fields: [
                    { type: "select", label: "Zones/Instances concernées", options: ["Zone Santé", "Zone Productivité", "Suivi Sommeil", "Suivi Eau"] },
                    { type: "select", label: "Période", options: ["7 derniers jours", "30 derniers jours", "Tout l'historique"] },
                    { type: "range", label: "Degré de détail", min: 1, max: 5, value: 3 },
                    { type: "range", label: "Importance", min: 1, max: 5, value: 4 }
                ]
            },
            use: {
                title: "📝 Configuration Utilisation",
                fields: [
                    { type: "select", label: "Lorem ipsum", options: ["Dolor sit amet", "Consectetur adipiscing", "Elit sed do"] },
                    { type: "select", label: "Eiusmod tempor", options: ["Incididunt ut", "Labore et dolore"] },
                    { type: "text", label: "Magna aliqua", placeholder: "Ut enim ad minim" }
                ]
            },
            create: {
                title: "✨ Configuration Création",
                fields: [
                    { type: "select", label: "Exercitation", options: ["Ullamco laboris", "Nisi ut aliquip", "Ex ea commodo"] },
                    { type: "select", label: "Aute irure", options: ["Dolor in", "Reprehenderit in", "Voluptate velit"] },
                    { type: "text", label: "Esse cillum", placeholder: "Dolore eu fugiat" }
                ]
            },
            modify: {
                title: "🔧 Configuration Modification",
                fields: [
                    { type: "select", label: "Nulla pariatur", options: ["Excepteur sint", "Occaecat cupidatat", "Non proident"] },
                    { type: "select", label: "Sunt in culpa", options: ["Qui officia", "Deserunt mollit", "Anim id"] },
                    { type: "textarea", label: "Est laborum", placeholder: "Sed ut perspiciatis unde..." }
                ]
            },
            organize: {
                title: "📁 Configuration Organisation",
                fields: [
                    { type: "select", label: "Omnis iste natus", options: ["Error sit", "Voluptatem accusantium", "Doloremque laudantium"] },
                    { type: "select", label: "Totam rem aperiam", options: ["Eaque ipsa", "Quae ab illo", "Inventore veritatis"] },
                    { type: "text", label: "Quasi architecto", placeholder: "Beatae vitae dicta" }
                ]
            },
            document: {
                title: "📚 Configuration Documentation",
                fields: [
                    { type: "select", label: "Sunt explicabo", options: ["Nemo enim", "Ipsam voluptatem", "Quia voluptas"] },
                    { type: "select", label: "Sit aspernatur", options: ["Aut odit", "Aut fugit", "Sed quia"] },
                    { type: "textarea", label: "Consequuntur magni", placeholder: "Dolores eos qui ratione..." }
                ]
            }
        };

        // Ouvrir config d'enrichissement
        function addEnrichment(type) {
            currentEnrichmentType = type;
            editingEnrichmentIndex = null;
            showConfigOverlay(type);
        }

        // Éditer enrichissement existant
        function editEnrichment(index) {
            const enrichment = enrichments[index];
            currentEnrichmentType = enrichment.type;
            editingEnrichmentIndex = index;
            showConfigOverlay(enrichment.type, enrichment.data);
        }

        function showConfigOverlay(type, existingData = null) {
            const config = enrichmentConfigs[type];
            document.getElementById('configTitle').textContent = config.title;
            
            let html = '';
            config.fields.forEach((field, index) => {
                html += `<div class="config-section">`;
                html += `<label class="config-label">${field.label}</label>`;
                
                switch(field.type) {
                    case 'select':
                        html += `<select class="config-select" data-field="${index}">`;
                        field.options.forEach(option => {
                            const selected = existingData && existingData[index] === option ? 'selected' : '';
                            html += `<option ${selected}>${option}</option>`;
                        });
                        html += `</select>`;
                        break;
                    case 'text':
                        const textValue = existingData ? existingData[index] : '';
                        html += `<input type="text" class="config-input" data-field="${index}" placeholder="${field.placeholder}" value="${textValue}">`;
                        break;
                    case 'textarea':
                        const textareaValue = existingData ? existingData[index] : '';
                        html += `<textarea class="config-textarea" data-field="${index}" placeholder="${field.placeholder}">${textareaValue}</textarea>`;
                        break;
                    case 'range':
                        const rangeValue = existingData ? existingData[index] : field.value;
                        html += `<input type="range" class="config-input" data-field="${index}" min="${field.min}" max="${field.max}" value="${rangeValue}">`;
                        break;
                }
                html += `</div>`;
            });
            
            document.getElementById('configContent').innerHTML = html;
            document.getElementById('configOverlay').classList.add('active');
        }

        function saveConfig() {
            const fields = document.querySelectorAll('[data-field]');
            const data = [];
            
            fields.forEach(field => {
                data[field.dataset.field] = field.value;
            });
            
            const enrichment = {
                type: currentEnrichmentType,
                data: data,
                text: generateEnrichmentText(currentEnrichmentType, data)
            };
            
            if (editingEnrichmentIndex !== null) {
                // Modification
                enrichments[editingEnrichmentIndex] = enrichment;
            } else {
                // Ajout
                enrichments.push(enrichment);
            }
            
            updateTextareaWithEnrichments();
            closeConfig();
        }

        function generateEnrichmentText(type, data) {
            const icons = {
                data: '🔍',
                use: '📝',
                create: '✨',
                modify: '🔧',
                organize: '📁',
                document: '📚'
            };
            
            const samples = {
                data: 'Zone Santé • 30 jours • Détail élevé',
                use: 'Suivi Eau +250ml à 14h30',
                create: 'Suivi Stress → Zone Santé',
                modify: 'Suivi Sommeil • Seuil alerte 6.5h→7h',
                organize: 'Créer zone "Bien-être"',
                document: 'Métadonnées explicatives'
            };
            
            return `${icons[type]} ${samples[type]}`;
        }

        function updateTextareaWithEnrichments() {
            const textarea = document.getElementById('messageTextarea');
            let content = textarea.value;
            
            // Nettoyer les enrichissements existants
            content = content.replace(/\n🔍[^\n]+\n/g, '\n').replace(/\n📝[^\n]+\n/g, '\n').replace(/\n✨[^\n]+\n/g, '\n').replace(/\n🔧[^\n]+\n/g, '\n').replace(/\n📁[^\n]+\n/g, '\n').replace(/\n📚[^\n]+\n/g, '\n');
            
            // Ajouter les enrichissements
            enrichments.forEach(enrichment => {
                content += `\n${enrichment.text}\n`;
            });
            
            textarea.value = content.trim();
        }

        function closeConfig() {
            document.getElementById('configOverlay').classList.remove('active');
        }

        // Envoi de message
        function sendMessage() {
            const textarea = document.getElementById('messageTextarea');
            if (textarea.value.trim()) {
                addMessageToChat('user', textarea.value, enrichments.length > 0);
                textarea.value = '';
                enrichments = [];
                
                // Simuler réponse IA
                setTimeout(() => {
                    addMessageToChat('ai', 'Message reçu ! Je traite vos demandes...');
                }, 800);
            }
        }

        function addMessageToChat(sender, content, hasEnrichments = false) {
            const messages = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            if (hasEnrichments) {
                // Convertir les enrichissements en blocs readonly
                content = content.replace(/\n(🔍|📝|✨|🔧|📁|📚)([^\n]+)\n/g, '<div class="enrichment-block readonly">$1$2</div>');
            }
            
            messageDiv.innerHTML = content;
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        // Gestion des événements clavier
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (document.getElementById('configOverlay').classList.contains('active')) {
                    closeConfig();
                } else if (document.getElementById('statusOverlay').classList.contains('active')) {
                    hideStatus();
                } else if (document.getElementById('historyOverlay').classList.contains('active')) {
                    hideHistory();
                } else if (document.getElementById('mobileKeyboard').classList.contains('active')) {
                    hideKeyboard();
                }
            }
        });

        // Fermer overlays en cliquant à côté
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('status-overlay')) {
                hideStatus();
            } else if (e.target.classList.contains('history-overlay')) {
                hideHistory();
            } else if (e.target.classList.contains('config-overlay')) {
                closeConfig();
            }
        });

        // Auto-resize textarea
        document.getElementById('messageTextarea').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });
    </script>
</body>
</html>